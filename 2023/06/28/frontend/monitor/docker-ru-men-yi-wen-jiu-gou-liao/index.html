<!--
 * @Author: yinhan 1738348915@qq.com
 * @Date: 2023-06-26 13:53:37
 * @LastEditors: yinhan 1738348915@qq.com
 * @LastEditTime: 2024-04-19 13:52:55
 * @FilePath: \zBlog\themes\hexo-theme-bamboo\layout\layout.ejs
 * @Description: 
-->
<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="referrer" content="no-referrer"/>
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>docker入门一文就够了 | 梨逍遥</title>

  <link rel="icon" type="image/png" href="https://s21.ax1x.com/2024/07/01/pkc7yAs.png">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="/js/swiper/swiper@5.4.1.min.css" rel="stylesheet">
  
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script defer src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    
    
    <!-- 依赖于jquery和vue -->
    
        <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
    

    
        <script src="https://unpkg.com/vue@2.6.11/dist/vue.min.js"></script>
    

    <!-- import link -->
    
        
            
        
            
        
    
    <!-- import script -->
    
        
            
        
            
        
    

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="梨逍遥" type="application/atom+xml">
</head>

  
  <!-- 预加载动画 -->
  <!-- 页面预加载动画 -->

  
    <div class="preloader-1" id="loader">
  <div  aria-label="Orange and tan hamster running in a metal wheel" role="img" class="wheel-and-hamster">
    <div class="wheel"></div>
    <div class="hamster">
      <div class="hamster__body">
        <div class="hamster__head">
          <div class="hamster__ear"></div>
          <div class="hamster__eye"></div>
          <div class="hamster__nose"></div>
        </div>
        <div class="hamster__limb hamster__limb--fr"></div>
        <div class="hamster__limb hamster__limb--fl"></div>
        <div class="hamster__limb hamster__limb--br"></div>
        <div class="hamster__limb hamster__limb--bl"></div>
        <div class="hamster__tail"></div>
      </div>
    </div>
    <div class="spoke"></div>
  </div>
</div>
  
<script>
  var endLoading = function () {
    document.body.style.overflow = 'auto';
    document.getElementById('loader').classList.add("loading");
  }
  window.addEventListener('DOMContentLoaded',endLoading);
</script>

  <body>
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 需要在上面加载的js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (src) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- 轮播图所需要的js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>

<script type="text/javascript">
  Vue.use(window.VueAwesomeSwiper)
</script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- 首页的公告滚动插件的js需要重新加载 -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- 打字机效果js -->
<script src="https://unpkg.com/typed.js@2.0.11"></script>


    <div id="safearea">
      <main class="main" id="pjax-container">
        <!-- 头部导航 -->
        
<header class="header  " 
  id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo lazyload placeholder" src="https://avatars.githubusercontent.com/u/48836340?v=4" class="lazyload placeholder" data-srcset="https://avatars.githubusercontent.com/u/48836340?v=4" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="logo">
      <h3 class="drawer-box-head_title">梨逍遥</h3>
      <h5 class="drawer-box-head_desc">代码改变世界，程序员创造未来</h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">Home</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">Archives</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">Tags</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">Categories</span>
                </a>
              
            </li>
          
        
        
          <li class="drawer-box-content_item">
            <a target="_blank" rel="noopener" href="https://gitee.com/yhyinhan">
              <i class="fas fa-github" aria-hidden="true"></i>
              <span>Github</span>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="https://avatars.githubusercontent.com/u/48836340?v=4" class="lazyload placeholder" data-srcset="https://avatars.githubusercontent.com/u/48836340?v=4" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="logo">
        </div>
      
      <a href="/" class="logo">梨逍遥</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="Home">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">Home</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="Archives">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">Archives</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="Tags">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">Tags</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link" title="Categories">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">Categories</span>
                </a>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">Search</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="Please enter keywords"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
    <a target="_blank" rel="noopener" href="https://gitee.com/yhyinhan" class="github-corner color-primary" aria-label="View source on GitHub"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  
  
</header>
        <!-- 内容区域 -->
        
 <!-- prismjs 代码高亮 -->
 


<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>


  <!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('https://images.pexels.com/photos/2387793/pexels-photo-2387793.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        docker入门一文就够了
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> Published in：2023-06-28 |
        </span>
      

      
        <span class="post-detail-header_categories">
          <i class="iconfont iconbookmark1"></i> category：
          
            <a href="/categories/%E5%89%8D%E7%AB%AF/" class="post-detail-header_category">
              前端
            </a>
          
            <a href="/categories/%E5%89%8D%E7%AB%AF/docker/" class="post-detail-header_category">
              docker
            </a>
          
        </span>
      

      
    
  </div>
  
  
    <script src="/js/bubble/bubble.js"></script>
  
</div>





<div class="post-detail-content post-row" 
  style="padding-top: 0px;">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <meta name="referrer" content="no-referrer" />

<blockquote>
<p>个人学习 docker 整理的一些资料和 demo，后续会根据新用到的功能不定期更新，有问题欢迎留言</p>
</blockquote>
<p><a name="YSAfK"></a></p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>docker 这个东西是什么就不介绍了，百度&#x2F;google 有很多，写这篇文章的初衷是记录一下自己在学习过程中的坑，避免后续可能会用到的情况下忘掉，其次给团队小伙伴入坑避避雷</p>
<p><a name="ITujW"></a></p>
<h1 id="docker-安装"><a href="#docker-安装" class="headerlink" title="docker 安装"></a>docker 安装</h1><p>强调一下学一个东西，一定要先进官网，一般比较优秀的项目文档都写得很不错的，比如<a target="_blank" rel="noopener" href="https://docs.docker.com/">docker 官网</a><br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611820093046-4aa3b4bd-28d9-4583-87da-f3043684b590.png#height=747&id=JKzut&originHeight=747&originWidth=1175&originalType=binary&ratio=1&rotation=0&showTitle=false&size=88361&status=done&style=none&title=&width=1175" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611820093046-4aa3b4bd-28d9-4583-87da-f3043684b590.png#height=747&id=JKzut&originHeight=747&originWidth=1175&originalType=binary&ratio=1&rotation=0&showTitle=false&size=88361&status=done&style=none&title=&width=1175" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />首先还是要安装一下 docker，点击<code>download and install</code><br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611820203756-00dd13dd-b1d9-48b7-9534-638c72b8e90c.png#height=527&id=NhF3D&originHeight=527&originWidth=1283&originalType=binary&ratio=1&rotation=0&showTitle=false&size=122387&status=done&style=none&title=&width=1283" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611820203756-00dd13dd-b1d9-48b7-9534-638c72b8e90c.png#height=527&id=NhF3D&originHeight=527&originWidth=1283&originalType=binary&ratio=1&rotation=0&showTitle=false&size=122387&status=done&style=none&title=&width=1283" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />安装完成后，打开终端工具，显示下图即安装成功<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611821090462-3860a71e-1d79-477f-b2ab-11951dc1a113.png#height=82&id=F3ANb&originHeight=82&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24155&status=done&style=none&title=&width=576" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611821090462-3860a71e-1d79-477f-b2ab-11951dc1a113.png#height=82&id=F3ANb&originHeight=82&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24155&status=done&style=none&title=&width=576" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="2JgW9"></a></p>
<h1 id="启动第一个容器"><a href="#启动第一个容器" class="headerlink" title="启动第一个容器"></a>启动第一个容器</h1><p>还记得刚才下载的<a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-mac/install/">docker desktop</a>么，除了提供 docker 环境外，本身也提供一个对新手非常友好的图形化界面，打开 docker desktop（默认会安装到“应用程序“），配置之类的可以暂时忽略，点击”dashboard”<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823573615-ca092c27-b987-45c4-a892-f217c17f149e.png#height=354&id=DzUcj&originHeight=354&originWidth=692&originalType=binary&ratio=1&rotation=0&showTitle=false&size=162909&status=done&style=none&title=&width=692" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823573615-ca092c27-b987-45c4-a892-f217c17f149e.png#height=354&id=DzUcj&originHeight=354&originWidth=692&originalType=binary&ratio=1&rotation=0&showTitle=false&size=162909&status=done&style=none&title=&width=692" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>会弹出一个图形化界面，此时默认在 containers 一栏，当前是没有任何容器的状态，可以看到中间有一段命令，复制执行一下<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823727345-1ed652b8-9643-46a5-a02b-ac70e301aa95.png#height=1440&id=rmeNO&originHeight=1440&originWidth=2500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=207491&status=done&style=none&title=&width=2500" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823727345-1ed652b8-9643-46a5-a02b-ac70e301aa95.png#height=1440&id=rmeNO&originHeight=1440&originWidth=2500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=207491&status=done&style=none&title=&width=2500" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>执行之后发现多了一个运行中的容器，端口号是 80，此时打开浏览器输入 127.0.0.1:80，<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823867302-195a61a6-43f8-4ea4-9ca9-f78860cbddcf.png#height=1440&id=fe69G&originHeight=1440&originWidth=2500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=141948&status=done&style=none&title=&width=2500" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823867302-195a61a6-43f8-4ea4-9ca9-f78860cbddcf.png#height=1440&id=fe69G&originHeight=1440&originWidth=2500&originalType=binary&ratio=1&rotation=0&showTitle=false&size=141948&status=done&style=none&title=&width=2500" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>打开了一个 docker 的帮助文档，此时已经成功通过 docker 启动了第一个服务<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823943031-acabd6aa-586f-4186-86be-1bc67ef94a86.png#height=625&id=kwNov&originHeight=625&originWidth=1567&originalType=binary&ratio=1&rotation=0&showTitle=false&size=109676&status=done&style=none&title=&width=1567" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611823943031-acabd6aa-586f-4186-86be-1bc67ef94a86.png#height=625&id=kwNov&originHeight=625&originWidth=1567&originalType=binary&ratio=1&rotation=0&showTitle=false&size=109676&status=done&style=none&title=&width=1567" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="YhK8S"></a></p>
<h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><p>学习 docker 一定要搞明白 “容器” 和 “镜像” 的概念，这个也是前端工程师很少接触的东西</p>
<p><a name="K9AWz"></a></p>
<h2 id="Docker-架构图"><a href="#Docker-架构图" class="headerlink" title="Docker 架构图"></a>Docker 架构图</h2><p>docker 架构简介： <a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/overview/">https://docs.docker.com/get-started/overview/</a><br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612336216279-218b1f0d-9b7a-4c4c-9bc5-36db402a4cae.png#height=527&id=McWuD&originHeight=527&originWidth=1009&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74779&status=done&style=none&title=&width=1009" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612336216279-218b1f0d-9b7a-4c4c-9bc5-36db402a4cae.png#height=527&id=McWuD&originHeight=527&originWidth=1009&originalType=binary&ratio=1&rotation=0&showTitle=false&size=74779&status=done&style=none&title=&width=1009" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="vjPeq"></a></p>
<h2 id="镜像（image）"><a href="#镜像（image）" class="headerlink" title="镜像（image）"></a>镜像（image）</h2><p>这个便于理解的话，可以想象成有点类似于提供所需运行环境的一个模板，给后续容器运行时使用，镜像本身是无状态的，或者说预期是无状态的（只读），镜像内容会保持在 build 时的状态</p>
<p>官方话说是：Docker images 由多个只读层组成，这些层是堆叠的，每个层都是上一层的变化的增量</p>
<p><a name="roFbS"></a></p>
<h2 id="容器（container）"><a href="#容器（container）" class="headerlink" title="容器（container）"></a>容器（container）</h2><p>依托于镜像提供的配置信息所创建的运行环境，各个容器之间相互独立，白话一点可以理解为启动了一台服务器</p>
<p>官方话来说是： Docker 将一个读写文件系统分配给容器，作为其最后一层。这允许运行中的容器在其本地文件系统中创建或修改文件和目录</p>
<p><a name="ZfbF3"></a></p>
<h2 id="镜像-x2F-容器-x2F-仓库三者关系"><a href="#镜像-x2F-容器-x2F-仓库三者关系" class="headerlink" title="镜像&#x2F;容器&#x2F;仓库三者关系"></a>镜像&#x2F;容器&#x2F;仓库三者关系</h2><p><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611826081072-7e6a7d24-f50e-45bc-be07-fed98783bcf8.png#height=316&id=APg2V&originHeight=316&originWidth=835&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36744&status=done&style=none&title=&width=835" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611826081072-7e6a7d24-f50e-45bc-be07-fed98783bcf8.png#height=316&id=APg2V&originHeight=316&originWidth=835&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36744&status=done&style=none&title=&width=835" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>大概的一个流程，获取镜像源，启动镜像生成容器，运行容器并绑定宿主机端口号，通过宿主机端口号即可访 docker 的服务，如”启动第一个容器”里所输入的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 80:80 docker/getting-started</span><br></pre></td></tr></table></figure>

<p>-p 80:80，即将 docekr 的 80 端口绑到宿主机上</p>
<p><a name="syNdT"></a></p>
<h1 id="拥有一个自己的镜像"><a href="#拥有一个自己的镜像" class="headerlink" title="拥有一个自己的镜像"></a>拥有一个自己的镜像</h1><p>了解镜像&#x2F;容器&#x2F;仓库的概念之后，会发现如果想要通过 docker 启动一个自己的应用，首先需要构建自己的镜像，<br />这时候可以通过 Dockerfile 实现</p>
<p><a href="#NZKgw">关于 DockerFile 说明</a></p>
<p><a name="ShOzT"></a></p>
<h2 id="创建一个-hello-world"><a href="#创建一个-hello-world" class="headerlink" title="创建一个 hello world"></a>创建一个 hello world</h2><p>新建一个文件夹，创建一个 start.sh 脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> helloWorld &amp;&amp; <span class="built_in">cd</span> helloWorld</span><br><span class="line"></span><br><span class="line">vim start.sh</span><br><span class="line"><span class="comment"># start.sh 文件内容</span></span><br><span class="line"><span class="built_in">echo</span> hello world</span><br><span class="line"></span><br><span class="line">vim Dockerfile</span><br></pre></td></tr></table></figure>

<p>Dockerfile 文件内容</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像linux alpine版</span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="comment"># 添加当前文件夹为根目录到容器的app文件夹</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /app/</span></span><br><span class="line"><span class="comment"># 设置根目录为/app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="comment"># 启动命令sh ./start.sh</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;./start.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>通过命令<code>docker build -t xuan/test .</code>生成镜像， 此时通过<code>docker image ls</code>即可查看镜像是生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 依次为镜像名，标签名，镜像id，创建时间， 镜像大小</span></span><br><span class="line">REPOSITORY               TAG                 IMAGE ID       CREATED         SIZE</span><br><span class="line">xuan/test                latest              af126024fa51   8 minutes ago   5.61MB</span><br></pre></td></tr></table></figure>

<p>后续删除镜像等操作比较依赖 image id，可以用该命令查询，在 dashboard 界面上也有相应显示<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611828329496-0fde1146-2880-49b1-b3fc-7ccba9f999f2.png#height=236&id=m0G5n&originHeight=236&originWidth=2428&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44207&status=done&style=none&title=&width=2428" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611828329496-0fde1146-2880-49b1-b3fc-7ccba9f999f2.png#height=236&id=m0G5n&originHeight=236&originWidth=2428&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44207&status=done&style=none&title=&width=2428" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="W2uhc"></a></p>
<h2 id="执行镜像"><a href="#执行镜像" class="headerlink" title="执行镜像"></a>执行镜像</h2><p><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611828384192-0f92ed7f-e99e-49fd-8ea7-58c2877f7f4a.png#height=34&id=pWahi&originHeight=34&originWidth=236&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2958&status=done&style=none&title=&width=236" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611828384192-0f92ed7f-e99e-49fd-8ea7-58c2877f7f4a.png#height=34&id=pWahi&originHeight=34&originWidth=236&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2958&status=done&style=none&title=&width=236" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />通过 docker run xuan&#x2F;test，即可运行镜像，可以看到 echo 出了 hello wold，说明镜像已经生成成功且可以运行</p>
<p><a name="cpLYq"></a></p>
<h2 id="容器自动停止？-why"><a href="#容器自动停止？-why" class="headerlink" title="容器自动停止？ why"></a>容器自动停止？ why</h2><p>但是这时候发现了一个问题，当使用<code>docker ps -l</code>查看容器状态时，发现已经自动停止服务了，这个是怎么回事呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令</span></span><br><span class="line">docker ps -l</span><br><span class="line"><span class="comment"># 状态</span></span><br><span class="line">CONTAINER ID   IMAGE       COMMAND           CREATED         STATUS                     PORTS     NAMES</span><br><span class="line">81b880ce6b37   xuan/test   <span class="string">&quot;sh ./start.sh&quot;</span>   2 minutes ago   Exited (0) 2 minutes ago             gracious_dewdney</span><br></pre></td></tr></table></figure>

<p><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611828602122-2bb12d6a-71cd-4739-a986-c9861903debd.png#height=128&id=cYI4R&originHeight=128&originWidth=826&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13334&status=done&style=none&title=&width=826" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611828602122-2bb12d6a-71cd-4739-a986-c9861903debd.png#height=128&id=cYI4R&originHeight=128&originWidth=826&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13334&status=done&style=none&title=&width=826" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />docker run 本身是执行一个进程，CMD 命令为 echo， echo 执行结束后进程自然而然终止，如果想让 docker 一直保持运行状态，必须在前台挂起一个程序<br />（这个知识点后续会用到）</p>
<p><a name="71gGd"></a></p>
<h1 id="练习：封装一个-node-服务镜像"><a href="#练习：封装一个-node-服务镜像" class="headerlink" title="练习：封装一个 node 服务镜像"></a>练习：封装一个 node 服务镜像</h1><p>通过上例，已经认识到如何构建一个镜像，但是例子比较简单无法应用于实战中，接下来封装一个 nodejs 服务器，<br />这里用到的框架是 koa</p>
<p><a name="P6aRL"></a></p>
<h2 id="创建-koa-服务"><a href="#创建-koa-服务" class="headerlink" title="创建 koa 服务"></a>创建 koa 服务</h2><p>创建一个文件夹，并新建 package.json</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建文件夹</span></span><br><span class="line"><span class="built_in">mkdir</span> koa2Docker &amp;&amp; <span class="built_in">cd</span> koa2Docker</span><br><span class="line"><span class="comment"># 初始化package.json</span></span><br><span class="line">npm init -y</span><br><span class="line"><span class="comment"># 安装koa</span></span><br><span class="line">npm install koa --save</span><br><span class="line"><span class="comment"># 创建app.js文件</span></span><br><span class="line">vim app.js</span><br></pre></td></tr></table></figure>

<p>app.js 内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title function_">koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">&quot;hello world xuan&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3001</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;已启动3001&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>koa 的最小服务已经搭建完成，启动看一下是否有问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">node app.js</span><br></pre></td></tr></table></figure>

<p>浏览器打开地址 localhost:3001，发现正常显示，说明服务正常，接下来看下怎么把这个服务封装成一个镜像<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611892740700-2fe7fd1a-071c-4254-b56b-e84323495d22.png#height=81&id=fUsqz&originHeight=81&originWidth=363&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7090&status=done&style=none&title=&width=363" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611892740700-2fe7fd1a-071c-4254-b56b-e84323495d22.png#height=81&id=fUsqz&originHeight=81&originWidth=363&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7090&status=done&style=none&title=&width=363" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="KLd4K"></a></p>
<h2 id="生成镜像"><a href="#生成镜像" class="headerlink" title="生成镜像"></a>生成镜像</h2><p>首先创建一个 dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">15.6</span>.<span class="number">0</span>-alpine3.<span class="number">10</span></span><br><span class="line"><span class="comment"># 添加当前文件到容器中的app</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /app/</span></span><br><span class="line"><span class="comment"># 设置工作目录为/app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="comment"># 安装包</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm i</span></span><br><span class="line"><span class="comment"># 开放当前3001接口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3001</span></span><br><span class="line"><span class="comment"># 默认启动命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;app.js&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>创建完成后 build 一下 <code>docker build -t xuan/hello .</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...以上胜率</span></span><br><span class="line">Step 5/6 : EXPOSE 3001</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 86dd3555883f</span><br><span class="line">Removing intermediate container 86dd3555883f</span><br><span class="line"> ---&gt; a9455b8dbf12</span><br><span class="line">Step 6/6 : CMD [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;app.js&quot;</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 41fd4f405d70</span><br><span class="line">Removing intermediate container 41fd4f405d70</span><br><span class="line"> ---&gt; c4f8645cf369</span><br><span class="line">Successfully built c4f8645cf369</span><br><span class="line">Successfully tagged xuan/hello:latest</span><br></pre></td></tr></table></figure>

<p>此时镜像已经打包成功，可以通过<code>docker images</code>查看，或者通过 desktop 查看<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611893168646-92de999a-1a9d-4afc-b32c-81cdc27fc611.png#height=578&id=pqEYJ&originHeight=578&originWidth=2078&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75987&status=done&style=none&title=&width=2078" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611893168646-92de999a-1a9d-4afc-b32c-81cdc27fc611.png#height=578&id=pqEYJ&originHeight=578&originWidth=2078&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75987&status=done&style=none&title=&width=2078" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="QTZB0"></a></p>
<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><p>镜像生成成功后，来测试下是否生成成功，输入<code>docker run xuan/hello</code> ，此时控制台显示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  koa2Docker docker run xuan/hello</span><br><span class="line">已启动3001</span><br></pre></td></tr></table></figure>

<p>使用浏览器打开 localhost:3001</p>
<p><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611893655163-d2a0d54f-7490-4ed3-8f08-1844171ff76f.png#height=244&id=Rgp7v&originHeight=343&originWidth=726&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22912&status=done&style=none&title=&width=516" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611893655163-d2a0d54f-7490-4ed3-8f08-1844171ff76f.png#height=244&id=Rgp7v&originHeight=343&originWidth=726&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22912&status=done&style=none&title=&width=516" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>并没有预期打开成功，而是显示无法访问，使用<code>docker ps -a</code>命令查看容器状况，发现容器本身是正常的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  hello docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS          PORTS      NAMES</span><br><span class="line">66eb8ba8d1d1   xuan/hello   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   14 seconds ago   Up 13 seconds   3001/tcp   vibrant_moser</span><br></pre></td></tr></table></figure>

<p>这是什么原因呢？<br />其实容器和本地机绑定需要依赖接口绑定才能进行访问的，<br />目前只开放了容器的 3001 接口，但是本地机是无法直接访问的，此时可以通过-p 参数来指定端口映射，修改一下启动命令为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3001:3001 xuan/hello</span><br></pre></td></tr></table></figure>

<p>重新打开浏览器， 可以正常访问服务<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611895240458-f1465438-9f11-4961-9d17-c8f7ff565a1a.png#height=87&id=nppou&originHeight=87&originWidth=320&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5385&status=done&style=none&title=&width=320" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611895240458-f1465438-9f11-4961-9d17-c8f7ff565a1a.png#height=87&id=nppou&originHeight=87&originWidth=320&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5385&status=done&style=none&title=&width=320" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />（注： 如果需要后台运行的话，可以加个 <code>-d</code> 命令）</p>
<p><a name="BqtYo"></a></p>
<h1 id="进阶：持久化存储"><a href="#进阶：持久化存储" class="headerlink" title="进阶：持久化存储"></a>进阶：持久化存储</h1><p><a name="EDi4k"></a></p>
<h2 id="为什么？"><a href="#为什么？" class="headerlink" title="为什么？"></a>为什么？</h2><p>因为 docker 的镜像本身是无状态的不会记录后续再容器中的任何操作，例如在 xuan&#x2F;hello 容器中修改中间件返回值，改为”edit”</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">&quot;edit&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>重新进行 docker run，新的容器没有任何变化，也就是无法保留任何不存在 build 镜像后的任何数据，这里就遇到了一个问题？ <br />使用 mysql 容器的的话，怎么保存 docker 环境下的 mysql 数据表更新，毕竟 reload 容器会丢失全部 data，这明显不是一个可以接受的事情</p>
<p>这里就引出 docker 的 volume 功能</p>
<p><a name="XtRcc"></a></p>
<h2 id="Volume-的类型"><a href="#Volume-的类型" class="headerlink" title="Volume 的类型"></a>Volume 的类型</h2><p>volume 分为 2 种模式，Named Volumes， Bind Mounts，下面是区别：</p>
<table>
<thead>
<tr>
<th></th>
<th>Named Volumes</th>
<th>Bind Mounts</th>
</tr>
</thead>
<tbody><tr>
<td>Host Location</td>
<td>Docker chooses</td>
<td>You control</td>
</tr>
<tr>
<td>Mount Example (using <code>-v</code><br />)</td>
<td>my-volume:&#x2F;usr&#x2F;local&#x2F;data</td>
<td>&#x2F;path&#x2F;to&#x2F;data:&#x2F;usr&#x2F;local&#x2F;data</td>
</tr>
<tr>
<td>Populates new volume with container contents</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Supports Volume Drivers</td>
<td>Yes</td>
<td>No</td>
</tr>
</tbody></table>
<p><a name="BdOtr"></a></p>
<h3 id="Named-Volumes"><a href="#Named-Volumes" class="headerlink" title="Named Volumes"></a>Named Volumes</h3><p>Named Volumes 是 docker 自己管理的 volume，通过 docker volumes create 创建</p>
<p><a name="BECrS"></a></p>
<h3 id="Bind-Mounts"><a href="#Bind-Mounts" class="headerlink" title="Bind Mounts"></a>Bind Mounts</h3><p>将宿主机与容器进行文件绑定映射，即不论在宿主机还是容器内进行文件修改，都会同步生效</p>
<p><a name="dat6w"></a></p>
<h2 id="怎么用？"><a href="#怎么用？" class="headerlink" title="怎么用？"></a>怎么用？</h2><p>这里分两种场景，一个是开发应用的时候需要宿主机和容器内的及时同步，另一个是 mysql 的数据同步，这里为了方便讲解我用的是 bind mounts 方式</p>
<p><a name="CTbvb"></a></p>
<h3 id="app-应用的更新"><a href="#app-应用的更新" class="headerlink" title="app 应用的更新"></a>app 应用的更新</h3><p>在上文更新中间件的情况下，发现如果在本地代码中进行修改，不会对容器有任何的影响，那么当有测试和开发的任务时，想要更新容器就只能够重复 打包镜像 -&gt; 运行容器这个动作，对开发有着比较大的阻碍</p>
<p>那么怎么利用 volume 进行本地代码和 docker 容器的联动呢？</p>
<p><a name="PHKg0"></a></p>
<h4 id="文件映射"><a href="#文件映射" class="headerlink" title="文件映射"></a>文件映射</h4><p>上面讲解过 bind mounts 是将本地文件和 docker 文件进行绑定，那么就来试一下，重新运行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3001:3001 -v /Users/xuan/Desktop/hello/koa2Docker:/app xuan/hello</span><br></pre></td></tr></table></figure>

<p>修改中间件 ctx.body &#x3D; ‘edit’</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title function_">koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">&quot;edit&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3001</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;.........3001&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>进入容器看下具体情况<code>docker exec -it dafe1b24c301 /bin/sh</code>，这里<code>dafe1b24c301</code>为容器 id，可以通过<code>docker ps -l </code>查看，进入容器后默认在<code>/app</code>文件夹下，查看 app.js 检查下状况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开app.js</span></span><br><span class="line">vi app.js</span><br></pre></td></tr></table></figure>

<p>app.js 可以看到 app.js 内部器是修改成功的<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611921182584-39987aa5-c107-4960-a9f3-442517ecfcfe.png#height=145&id=TXRDw&originHeight=145&originWidth=238&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7795&status=done&style=none&title=&width=238" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611921182584-39987aa5-c107-4960-a9f3-442517ecfcfe.png#height=145&id=TXRDw&originHeight=145&originWidth=238&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7795&status=done&style=none&title=&width=238" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="qLkwD"></a></p>
<h4 id="服务更新"><a href="#服务更新" class="headerlink" title="服务更新"></a>服务更新</h4><p>刷新浏览器，发现没什么变化，这个其实是因为虽然修改了文件，但实际上服务没有重启，实际上平时写 nodejs 也是每次更新要手动重启下服务<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611920582354-97be5080-544c-4e87-a558-23b971408769.png#height=87&id=eJsyh&originHeight=87&originWidth=320&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5385&status=done&style=none&title=&width=320" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611920582354-97be5080-544c-4e87-a558-23b971408769.png#height=87&id=eJsyh&originHeight=87&originWidth=320&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5385&status=done&style=none&title=&width=320" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />重启下容器 <code>docker restart dafe1b24c301</code>，刷新浏览器<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611921434993-6e194ee1-454e-4391-a60d-54fef6ad8320.png#height=76&id=sVD7y&originHeight=76&originWidth=276&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4265&status=done&style=none&title=&width=276" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611921434993-6e194ee1-454e-4391-a60d-54fef6ad8320.png#height=76&id=sVD7y&originHeight=76&originWidth=276&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4265&status=done&style=none&title=&width=276" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />页面更新成功</p>
<p><a name="5Inzg"></a></p>
<h4 id="pm2-自动刷新"><a href="#pm2-自动刷新" class="headerlink" title="pm2 自动刷新"></a>pm2 自动刷新</h4><p>平时在开发的时候为了避免每次修改都要进行服务器重启操作，通常会使用 pm2 帮监听文件变化，一旦文件内容变动自动重启服务，帮助节约时间，这里同理</p>
<p>在 dockerfile 里添加 pm2 的全局安装，修改 cmd 命令，通过<code>pm2-runtime app.js --watch</code>进行启动</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">15.6</span>.<span class="number">0</span>-alpine3.<span class="number">10</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /app/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install pm2 -g</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm i</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3001</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;pm2-runtime&quot;</span>, <span class="string">&quot;app.js&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>重新打包一个镜像并运行，重新打开浏览器，修改 app.js 文件内 ctx.body &#x3D; ‘pm2 start’</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker build -t xuan/hello .</span><br><span class="line">docker run -p 3001:3001 -v /Users/xuan/Desktop/hello/koa2Docker:/app xuan/hello</span><br><span class="line"><span class="comment"># log</span></span><br><span class="line">2021-01-29T12:17:52: PM2 <span class="built_in">log</span>: Launching <span class="keyword">in</span> no daemon mode</span><br><span class="line">2021-01-29T12:17:52: PM2 <span class="built_in">log</span>: [Watch] Start watching app</span><br><span class="line">2021-01-29T12:17:52: PM2 <span class="built_in">log</span>: App [app:0] starting <span class="keyword">in</span> -fork mode-</span><br><span class="line">2021-01-29T12:17:52: PM2 <span class="built_in">log</span>: App [app:0] online</span><br><span class="line">已启动3001</span><br></pre></td></tr></table></figure>

<p><code>command + R</code> 刷新浏览器，发现内容已经修改<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611923103974-4e8ce0cc-1df0-4895-96a0-598dca842be2.png#height=87&id=MBfR8&originHeight=87&originWidth=333&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5001&status=done&style=none&title=&width=333" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611923103974-4e8ce0cc-1df0-4895-96a0-598dca842be2.png#height=87&id=MBfR8&originHeight=87&originWidth=333&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5001&status=done&style=none&title=&width=333" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="FiOlw"></a></p>
<h4 id="额外关注"><a href="#额外关注" class="headerlink" title="额外关注"></a>额外关注</h4><p>突发奇想一下，从创建 app 应用到最终通过端口号访问服务，其实是<strong>没有任何依赖于宿主机的开发环境</strong>的，也就是说，<strong>在本机上，只要有 docker 环境，就可以进行正常业务的开发</strong></p>
<p>这也是 docker 带来的便利之处<br><a name="rMYlu"></a></p>
<h3 id="mysql-持久存储案例"><a href="#mysql-持久存储案例" class="headerlink" title="mysql 持久存储案例"></a>mysql 持久存储案例</h3><p>docker 一般情况下推荐一个 container 只做一件事情，这样即使一个容器挂了也很容易回复和查找原因，所以通常会用单独的容器运行 mysql</p>
<p>这里也就会遇到前文所说的问题： <br />镜像是无状态的，重新启动 image 的时候数据库保存的信息不会保留，不符合持久存储的预期</p>
<p>所以需要将数据库的 data 在宿主机同时保存一份，这样重新启动的时候会将本地的库同步到新的容器之中</p>
<p><a name="1OILg"></a></p>
<h4 id="文件映射-1"><a href="#文件映射-1" class="headerlink" title="文件映射"></a>文件映射</h4><p>这里为了讲解方便直接用了 docker-compose 配置文件说明，这里不用太抠细节，后续会将 docker-compose，可以找到 volumes 一行  <code>./mysql-data:/var/lib/mysql</code>，<br />将当前目录下的 mysql-data 和容器里的&#x2F;var&#x2F;lib&#x2F;mysql 进行关联</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">xuanlazy/koa:0.0.6</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3001</span><span class="string">:3001</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/app</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./:/app</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_HOST:</span> <span class="string">mysql</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">MYSQL_DB:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3307</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./db:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123456</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>

<p>启动服务后，发现当前目录下多了一个 db 文件夹，可以看到已经把当前 mysql 整库拖出来<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611924465137-435929f3-20ee-4946-a89d-893cdbbe4e59.png#height=484&id=Mpn6z&originHeight=484&originWidth=365&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24982&status=done&style=none&title=&width=365" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1611924465137-435929f3-20ee-4946-a89d-893cdbbe4e59.png#height=484&id=Mpn6z&originHeight=484&originWidth=365&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24982&status=done&style=none&title=&width=365" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="hXsqG"></a></p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>在 mysql 里创建一个表，并且插入数据，下面是现成的的 sql：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 创建表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> runoob_tbl (</span><br><span class="line">        runoob_id <span class="type">INT</span> UNSIGNED AUTO_INCREMENT,</span><br><span class="line">        runoob_title <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">        runoob_author <span class="type">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">        submission_date <span class="type">DATE</span>,</span><br><span class="line">        <span class="keyword">PRIMARY</span> KEY ( runoob_id )</span><br><span class="line">)ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"># 插入数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> runoob_tbl</span><br><span class="line">    (runoob_title, runoob_author, submission_date)</span><br><span class="line">    <span class="keyword">VALUES</span></span><br><span class="line">    (&quot;学习Dcoker&quot;, &quot;test&quot;, NOW())</span><br><span class="line"></span><br><span class="line"># 查询<span class="keyword">sql</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> runoob_tbl;</span><br></pre></td></tr></table></figure>

<p>存储成功后，停掉服务，重启的时候可以试下注释掉 volumes，看下区别（这里操作比较复杂信息量也少就不具挂例子了）<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612151638862-a7c6b418-dbbe-466c-9c3d-0fb4a088226c.png#height=48&id=D6DNg&originHeight=48&originWidth=304&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4648&status=done&style=none&title=&width=304" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612151638862-a7c6b418-dbbe-466c-9c3d-0fb4a088226c.png#height=48&id=D6DNg&originHeight=48&originWidth=304&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4648&status=done&style=none&title=&width=304" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>其实答案应该也猜得到，有挂 volumes 的情况下之前存的数据可以再次查询到，注释掉的情况下相当于启用的是一个新数据库</p>
<p><a name="rdY0e"></a></p>
<h1 id="进阶：多容器组合联动"><a href="#进阶：多容器组合联动" class="headerlink" title="进阶：多容器组合联动"></a>进阶：多容器组合联动</h1><p><a name="wRn2L"></a></p>
<h2 id="为什么要多容器联动？"><a href="#为什么要多容器联动？" class="headerlink" title="为什么要多容器联动？"></a>为什么要多容器联动？</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/07_multi_container/">官方文档</a>有写：</p>
<ul>
<li>很有可能需要以与数据库不同的方式扩展 API 和前端</li>
<li>单独的容器可让您隔离版本和更新版本</li>
<li>虽然您可以在本地使用数据库的容器，但可能要在生产环境中使用数据库的托管服务。然后，您不想随应用程序一起提供数据库引擎</li>
<li>运行多个进程将需要一个进程管理器（容器仅启动一个进程），这增加了容器启动&#x2F;关闭的复杂性</li>
</ul>
<p>所以通常针对一个服务拆成多个容器，例如：koa + mysql + nginx 服务，通常会分成 koa，mysql，nginx 三个容器，那么 docker 作为容器是完全使用沙箱机制，相互之间不会有任何接口，那么怎么进行联动呢？</p>
<p><a name="3Qfy5"></a></p>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><p>其实 docker 提供了 network 能力，当两个容器在同一个网络的情况下就可以进行通讯，<br />使用 <code>docker network ls</code> 查看当前网络状况，默认情况下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">e6a4baa5f217   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">66a3ddcbaa06   host      host      <span class="built_in">local</span></span><br><span class="line">5d3adcd8922e   none      null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure>

<p>具体含义可以查询 <a target="_blank" rel="noopener" href="https://docs.docker.com/network/">network 文档</a> ，<br />对于实际应用来说可以通过<code>docker network create test-app</code>新建一个新的网络</p>
<p>验证一下，分别用以下两条命令分别启动两台容器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一会进入的主机</span></span><br><span class="line">docker run -d</span><br><span class="line">--network test-app           <span class="comment"># 使用test-app 网络</span></span><br><span class="line">--network-alias start-1      <span class="comment"># 网络名start-1</span></span><br><span class="line">--name test-host             <span class="comment"># 容器名</span></span><br><span class="line">docker/getting-started</span><br><span class="line"></span><br><span class="line"><span class="comment"># 子服务</span></span><br><span class="line">docker run -d</span><br><span class="line">--network test-app</span><br><span class="line">--network-alias start-2</span><br><span class="line">--name test-child</span><br><span class="line">docker/getting-started</span><br></pre></td></tr></table></figure>

<p>此时进入容器看一下， <code>docker exec -it test-host /bin/sh</code> ，找到开启的子服务网络别名 start-2，直接用 ping 就好了<code>ping start-2</code> ，可以看到已经链接成功<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612242375753-c5f94fd9-00a4-4e4e-95a5-57a02b3b045d.png#height=112&id=ig788&originHeight=112&originWidth=325&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10120&status=done&style=none&title=&width=325" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612242375753-c5f94fd9-00a4-4e4e-95a5-57a02b3b045d.png#height=112&id=ig788&originHeight=112&originWidth=325&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10120&status=done&style=none&title=&width=325" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>通过启动容器时指定 <code>--network</code>  可以让很方便的建立容器和容器之间的链接，例如 mysql 和应用的通讯</p>
<p>但是另一面每次都需要启动容器时手动指定 network，公开 port，挂载 volume 实在是有点累，且不方便规模化（可复制），这时候就需要 docker compose，帮进行组装</p>
<p><a name="F9RFO"></a></p>
<h2 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker compose"></a>docker compose</h2><p><a name="P8cVM"></a></p>
<h3 id="什么是-docker-compose？"><a href="#什么是-docker-compose？" class="headerlink" title="什么是 docker compose？"></a>什么是 docker compose？</h3><p>官方给的定义： Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your application’s services. Then, with a single command, you create and start all the services from your configuration.</p>
<p>翻译下其实就是，用于定义和运行多容器 Docker 应用程序的工具，通过 YAML 文件来配置应用程序的服务，使用一个命令读取配置并创建启动所有服务</p>
<p><a name="JzO5t"></a></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>关于安装如果是最新的 docker desktop 是自带的， <code>docker-compose version</code> 就可以查看版本号</p>
<p><a name="yDTao"></a></p>
<h3 id="解读配置文件"><a href="#解读配置文件" class="headerlink" title="解读配置文件"></a>解读配置文件</h3><p>想了想，还是通过配置文件反推比较好理解一些，下面便是一个简单的 node + mysql 的配置文件,来看看它到底做了哪些事？</p>
<p>docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3001</span><span class="string">:3001</span></span><br><span class="line">    <span class="attr">working_dir:</span> <span class="string">/app</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./:/app</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_HOST:</span> <span class="string">sql</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">test123456</span></span><br><span class="line">      <span class="attr">MYSQL_DB:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3307</span><span class="string">:3306</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/var/mysql:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">test123456</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>

<p>version – 定义当前配置文件所使用的文件格式版本，不同的版本可能会存在兼容问题，<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/">具体文档</a><br />services – 服务列表<br />app – 定义单例服务<br />image –所用镜像<br />container_name –容器名<br />ports –端口映射<br />working_dir –工作目录，等同于 Dockerfile 中的 workdir<br />volumes – 等同于 docker run -v <br />environment – 设置环境变量</p>
<p>更多配置信息: <a target="_blank" rel="noopener" href="https://docs.docker.com/compose/compose-file/compose-file-v3/">https://docs.docker.com/compose/compose-file/compose-file-v3/</a></p>
<p><a name="L02Dl"></a></p>
<h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><p>其实在 services 下的配置服务，大致可以理解为将 dockerfile 和 docker run 的很多信息展示在一个配置表中，例如 -v, -p，working_dir，方便统一管理</p>
<p>依旧是使用刚才的配置表，执行<code>docker-compose up</code>即可启动服务，通过 desktop 查看<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612327541583-f26025e9-7fce-4246-9aa3-b1d22c4fef76.png#height=392&id=idoXF&originHeight=392&originWidth=816&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27043&status=done&style=none&title=&width=816" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612327541583-f26025e9-7fce-4246-9aa3-b1d22c4fef76.png#height=392&id=idoXF&originHeight=392&originWidth=816&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27043&status=done&style=none&title=&width=816" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>这里需要注意一点 docker-compose 之所以能够让多个容器互相通信连在一起，并不是有多特殊，而是帮忙做了一些事情，例如创建网络<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612327021345-730ee1d6-3830-4ba6-abd4-7859b00214c0.png#height=69&id=lMHzm&originHeight=69&originWidth=392&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7942&status=done&style=none&title=&width=392" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612327021345-730ee1d6-3830-4ba6-abd4-7859b00214c0.png#height=69&id=lMHzm&originHeight=69&originWidth=392&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7942&status=done&style=none&title=&width=392" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />可以看到提示信息第一条就是 create network “test_node_default”，通过<code>docker network list</code>查看，确实是新加了一条网络<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612327158020-b6cacad7-ce2f-4a86-8ef5-95f2f3720161.png#height=88&id=a88wr&originHeight=88&originWidth=305&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9953&status=done&style=none&title=&width=305" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612327158020-b6cacad7-ce2f-4a86-8ef5-95f2f3720161.png#height=88&id=a88wr&originHeight=88&originWidth=305&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9953&status=done&style=none&title=&width=305" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="1b3zM"></a></p>
<h3 id="常用指令整理"><a href="#常用指令整理" class="headerlink" title="常用指令整理"></a>常用指令整理</h3><ul>
<li>docker-compose up –部署应用，添加-d 参数可以后台运行</li>
<li>docker-compose stop –停止所有应用</li>
<li>docker-compose rm –删除已停止的应用，但不会清除 volumes &#x2F; 镜像 &#x2F; 网络</li>
<li>docker-compose restart –重启应用</li>
<li>docker-compose down –停止并删除运行中的应用</li>
<li>docker-compose ps –显所有容器示</li>
</ul>
<p>更多指令：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/reference/overview/">https://docs.docker.com/compose/reference/overview/</a></p>
<p><a name="kGE9N"></a></p>
<h3 id="一些案例"><a href="#一些案例" class="headerlink" title="一些案例"></a>一些案例</h3><p><a name="WV1qg"></a></p>
<h4 id="链接-mongoDB"><a href="#链接-mongoDB" class="headerlink" title="链接 mongoDB"></a>链接 mongoDB</h4><p>docker-compose 启动容器虽然在同一 network 下，但是容器间的 ip 还是不一样的，无法直接用 127.0.0.1 &#x2F; 0.0.0.0 链接，需要修改一下 url</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb://root:mongodb@mongodb:27017/admin</span><br></pre></td></tr></table></figure>

<p><a name="NZKgw"></a></p>
<h1 id="DockerFile-配置详解"><a href="#DockerFile-配置详解" class="headerlink" title="DockerFile 配置详解"></a>DockerFile 配置详解</h1><p>官方文档： <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a><br />DockerFile 最佳实践： <a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">https://docs.docker.com/develop/develop-images/dockerfile_best-practices&#x2F;</a></p>
<p><a name="f7o58"></a></p>
<h1 id="DockerHub-远程仓库"><a href="#DockerHub-远程仓库" class="headerlink" title="DockerHub 远程仓库"></a>DockerHub 远程仓库</h1><p>官方文档： <a target="_blank" rel="noopener" href="https://www.docker.com/products/docker-hub">https://www.docker.com/products/docker-hub</a><br />Docker Hub 是 Docker 官方提供的托管存储库服务，用于与团队查找和共享容器映像。主要功能包括：</p>
<ul>
<li>专用存储库：推拉容器图像</li>
<li>自动化构建：自动从 GitHub 和 Bitbucket 构建容器映像并将其推送到 Docker Hub</li>
<li>团队和组织：管理对私有存储库的访问</li>
<li>官方映像：提取并使用 Docker 提供的高质量容器映像</li>
<li>发布者图像：拉出并使用外部供应商提供的高质量容器图像。认证映像还包括支持并保证与 Docker Enterprise 的兼容性</li>
<li>Webhooks：成功推送到存储库以将 Docker Hub 与其他服务集成后触发动作</li>
</ul>
<p>其实有点类似于 github，默认 pull 的镜像源其实就于 dockerhub，也可以 push 自己的镜像到线上<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612333810974-37a2a01d-d0ef-4ead-9b68-5291b394edae.png#height=346&id=dkLz5&originHeight=346&originWidth=1279&originalType=binary&ratio=1&rotation=0&showTitle=false&size=43904&status=done&style=none&title=&width=1279" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612333810974-37a2a01d-d0ef-4ead-9b68-5291b394edae.png#height=346&id=dkLz5&originHeight=346&originWidth=1279&originalType=binary&ratio=1&rotation=0&showTitle=false&size=43904&status=done&style=none&title=&width=1279" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="XMDf0"></a></p>
<h2 id="配置仓库"><a href="#配置仓库" class="headerlink" title="配置仓库"></a>配置仓库</h2><p><a name="UpQsf"></a></p>
<h3 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h3><p>如果是生产环境的话，还是推荐建一个私有仓库用来进行托管，这里使用的是阿里云的容器镜像服务，应该是免费的，可以自己看下<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612334146137-f5c60160-39c5-45d6-86ef-215b99f9fdd2.png#height=331&id=VnIAc&originHeight=331&originWidth=686&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29883&status=done&style=none&title=&width=686" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612334146137-f5c60160-39c5-45d6-86ef-215b99f9fdd2.png#height=331&id=VnIAc&originHeight=331&originWidth=686&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29883&status=done&style=none&title=&width=686" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="nCInf"></a></p>
<h3 id="docker-Registry"><a href="#docker-Registry" class="headerlink" title="docker Registry"></a>docker Registry</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/registry/">https://docs.docker.com/registry/</a></p>
<p>貌似可以通过 registry 镜像搭建私人仓库，还没试过</p>
<p><a name="5kNcS"></a></p>
<h1 id="docker-slim-镜像压缩"><a href="#docker-slim-镜像压缩" class="headerlink" title="docker-slim 镜像压缩"></a>docker-slim 镜像压缩</h1><p>这个是关于 docker 镜像的压缩工具，可以帮助制作 slim 版本的镜像，仓库地址：<a target="_blank" rel="noopener" href="https://github.com/docker-slim/docker-slim">点击这里</a></p>
<p><a name="bV50D"></a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>首先看下官方介绍，大致的意思不需要任何额外的操作，就可以获得最小的镜像，并且给出了个比较夸张的数字，优化 30 倍，看了下 github 有了 9.6k，还是比较可靠的<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612170500155-d3e37a6b-d47c-4e88-805b-76efe2647af1.png#height=195&id=L8xQu&originHeight=195&originWidth=733&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100695&status=done&style=none&title=&width=733" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612170500155-d3e37a6b-d47c-4e88-805b-76efe2647af1.png#height=195&id=L8xQu&originHeight=195&originWidth=733&originalType=binary&ratio=1&rotation=0&showTitle=false&size=100695&status=done&style=none&title=&width=733" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br><a name="7U81Q"></a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>官方介绍：<code>docker-slim</code> will optimize and secure your containers by understanding your application and what it needs using various analysis techniques.</p>
<p>按官方文档来解释，docker-slim 是通过依赖分析干掉镜像中没有产生使用的文件&#x2F;内容，从而节约体积</p>
<p><a name="fVGpb"></a></p>
<h2 id="试用测评"><a href="#试用测评" class="headerlink" title="试用测评"></a>试用测评</h2><p>将刚才的 demo 用来做下实验，效果确实比较惊人</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:dubnium-buster-slim</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /app/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm config <span class="built_in">set</span> registry http://registry.npm.taobao.org  &amp;&amp; npm install pm2 -g &amp;&amp; npm i</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3001</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;pm2-runtime&quot;</span>, <span class="string">&quot;./app.js&quot;</span>, <span class="string">&quot;--watch&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>一个简单的 dockerfile 打包完之后，之前的情况下是 588.52MB，打包后缩小了 11 倍以上，默默收藏<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612170858696-07d50b71-74de-4ebd-896c-ec3153723508.png#height=248&id=B4rdA&originHeight=248&originWidth=1820&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41851&status=done&style=none&title=&width=1820" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612170858696-07d50b71-74de-4ebd-896c-ec3153723508.png#height=248&id=B4rdA&originHeight=248&originWidth=1820&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41851&status=done&style=none&title=&width=1820" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="QbGby"></a></p>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>下载地址: <a target="_blank" rel="noopener" href="https://github.com/docker-slim/docker-slim/releases">https://github.com/docker-slim/docker-slim/releases</a><br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612172423751-0cdcce71-6262-4acf-b775-92622e7a3c1a.png#height=90&id=o8QDH&originHeight=90&originWidth=1198&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18311&status=done&style=none&title=&width=1198" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612172423751-0cdcce71-6262-4acf-b775-92622e7a3c1a.png#height=90&id=o8QDH&originHeight=90&originWidth=1198&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18311&status=done&style=none&title=&width=1198" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612172998730-15df8c10-776b-4d2c-a847-255fc4451102.png#height=49&id=ypKU3&originHeight=49&originWidth=735&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12899&status=done&style=none&title=&width=735" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612172998730-15df8c10-776b-4d2c-a847-255fc4451102.png#height=49&id=ypKU3&originHeight=49&originWidth=735&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12899&status=done&style=none&title=&width=735" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />将 docekr-slim 和 docker-slim-sensor 移动到&#x2F;usr&#x2F;local&#x2F;bin 文件夹下，这样可以在全局使用 docker-slim 命令，命令行输入 <code>docker-slim -v</code> ，显示版本信息表明安装成功<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612173355856-2789cc0a-f9d6-4801-8312-f5f4bb21f1e1.png#height=29&id=EdPhu&originHeight=29&originWidth=660&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6242&status=done&style=none&title=&width=660" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612173355856-2789cc0a-f9d6-4801-8312-f5f4bb21f1e1.png#height=29&id=EdPhu&originHeight=29&originWidth=660&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6242&status=done&style=none&title=&width=660" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="ChgV2"></a></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>在使用 docker-slim 对镜像进行压缩前需要提前打包一次，docker build -t test . <br />拿到打包生成的 image ID，使用 docker-slim build –target [image ID]，即自动生成[image Name].slim 格式的镜像，如下：<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612174796912-5c448835-3cdf-4edf-9e69-eb8704a10759.png#height=176&id=ik59S&originHeight=176&originWidth=1748&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31121&status=done&style=none&title=&width=1748" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612174796912-5c448835-3cdf-4edf-9e69-eb8704a10759.png#height=176&id=ik59S&originHeight=176&originWidth=1748&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31121&status=done&style=none&title=&width=1748" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="FmcFF"></a></p>
<h2 id="需要注意的坑"><a href="#需要注意的坑" class="headerlink" title="需要注意的坑"></a>需要注意的坑</h2><p>如果预期需要使用 docker-slim 进行压缩，那么不要使用 npm scripts 这样的命令，在当前版本里 npm scripts 是无法被依赖分析读取的，也就是说会干掉全局状态下的 node_modules，导致应用无法被启动</p>
<p>例如：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 错误案例</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;npm&quot;</span>, <span class="string">&quot;start&quot;</span>]  -&gt; npm start 等于<span class="string">&quot;start&quot;</span>: <span class="string">&quot;pm2-runtime app.js --watch&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正确案例</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;pm2-runtime&quot;</span>, <span class="string">&quot;./app.js&quot;</span>, <span class="string">&quot;--watch&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>具体的 issue： <a target="_blank" rel="noopener" href="https://github.com/docker-slim/docker-slim/issues/150">https://github.com/docker-slim/docker-slim/issues/150</a><br><a name="03NYR"></a></p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p><a name="PbfYJ"></a></p>
<h1 id="配置-github-CI-x2F-CD"><a href="#配置-github-CI-x2F-CD" class="headerlink" title="配置 github CI&#x2F;CD"></a>配置 github CI&#x2F;CD</h1><p>官方文档： <a target="_blank" rel="noopener" href="https://docs.docker.com/ci-cd/github-actions/">https://docs.docker.com/ci-cd/github-actions/</a></p>
<p><a name="uUmD5"></a></p>
<h1 id="更换-docker-源-–国内-cdn"><a href="#更换-docker-源-–国内-cdn" class="headerlink" title="更换 docker 源 –国内 cdn"></a>更换 docker 源 –国内 cdn</h1><p>毕竟国外的资源部分情况下还是比较慢（慢的过分..），同理 npm 一般要换成淘宝源或者使用 cnpm，这里的话我用的是阿里云的源</p>
<p><a name="okH7n"></a></p>
<h2 id="查看当前状态"><a href="#查看当前状态" class="headerlink" title="查看当前状态"></a>查看当前状态</h2><p>输入 <code>docker info</code> 查看当前 docker 基础信息，行数比较多，可以直接 <code>command + F</code> 搜索 ”Registry”，一般情况下会显示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方镜像源</span></span><br><span class="line">Registry: https://index.docker.io/v1/</span><br></pre></td></tr></table></figure>

<p><a name="HVEpl"></a></p>
<h2 id="阿里云镜像源"><a href="#阿里云镜像源" class="headerlink" title="阿里云镜像源"></a>阿里云镜像源</h2><p>登录阿里云账号：<a target="_blank" rel="noopener" href="https://www.aliyun.com/">https://www.aliyun.com/</a>，找到容器镜像服务 -&gt; 镜像工具 -&gt; 镜像加速器，<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612182190580-baeec99e-52ad-485e-8e48-c967e49c4b3a.png#height=359&id=Nco5x&originHeight=359&originWidth=509&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28848&status=done&style=none&title=&width=509" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612182190580-baeec99e-52ad-485e-8e48-c967e49c4b3a.png#height=359&id=Nco5x&originHeight=359&originWidth=509&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28848&status=done&style=none&title=&width=509" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612182857294-743dfc53-7eb3-46b8-9104-81c81db5cc6c.png#height=918&id=YmKxm&originHeight=918&originWidth=878&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104263&status=done&style=none&title=&width=878" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612182857294-743dfc53-7eb3-46b8-9104-81c81db5cc6c.png#height=918&id=YmKxm&originHeight=918&originWidth=878&originalType=binary&ratio=1&rotation=0&showTitle=false&size=104263&status=done&style=none&title=&width=878" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="VLk8r"></a></p>
<h2 id="设置-Preferences"><a href="#设置-Preferences" class="headerlink" title="设置 Preferences"></a>设置 Preferences</h2><p>如果是最新的 docker desktop 可以略过前面的文字，直接找到这段，按流程操作，找到 preferences，添加到 json 中，重启 docker 服务即可<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612182951498-68b082aa-3e73-424d-b2fe-6ce632286864.png#height=792&id=bhhlX&originHeight=792&originWidth=2080&originalType=binary&ratio=1&rotation=0&showTitle=false&size=117634&status=done&style=none&title=&width=2080" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612182951498-68b082aa-3e73-424d-b2fe-6ce632286864.png#height=792&id=bhhlX&originHeight=792&originWidth=2080&originalType=binary&ratio=1&rotation=0&showTitle=false&size=117634&status=done&style=none&title=&width=2080" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />发现多了一行<code>Registry Mirrors</code>即添加成功，此时可以重新<code>docker pull [images]</code>体验一下新的速度~<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612183398620-5885dd9b-705d-4913-abfc-08fd1cfba1a1.png#height=133&id=gxwpL&originHeight=133&originWidth=327&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10126&status=done&style=none&title=&width=327" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612183398620-5885dd9b-705d-4913-abfc-08fd1cfba1a1.png#height=133&id=gxwpL&originHeight=133&originWidth=327&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10126&status=done&style=none&title=&width=327" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p><a name="6KBm1"></a></p>
<h1 id="杂项知识"><a href="#杂项知识" class="headerlink" title="杂项知识"></a>杂项知识</h1><p><a name="3hhwH"></a></p>
<h2 id="读懂-docker-tag"><a href="#读懂-docker-tag" class="headerlink" title="读懂 docker tag"></a>读懂 docker tag</h2><p>一般镜像名的 tag 都会带一些后缀，以 node 为例，如下图： <br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612153220352-3636745e-4f35-486c-b597-be358c7b0ce2.png#height=664&id=Amb2v&originHeight=664&originWidth=1225&originalType=binary&ratio=1&rotation=0&showTitle=false&size=115197&status=done&style=none&title=&width=1225" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612153220352-3636745e-4f35-486c-b597-be358c7b0ce2.png#height=664&id=Amb2v&originHeight=664&originWidth=1225&originalType=binary&ratio=1&rotation=0&showTitle=false&size=115197&status=done&style=none&title=&width=1225" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>可以看到 tag 名多的眼花缭乱，第一次看大概率会懵逼，这里就大概解释下，其实所有的这些标签名都是对应基础镜像版本，如下：</p>
<p>linux 发行版： alpine， debian<br />debian 版本下 linux 代差：</p>
<ul>
<li>buster Debian10 （目前 node 默认）</li>
<li>stretch Debian9</li>
<li>jessie Debian8</li>
<li>wheezy Debian7</li>
</ul>
<p>slim 为修饰词，如 buster-slim，为 buster 版本下的删减版</p>
<p>这一下来看的话就比较清晰了，alpine 和 debian 对比来看的话，alpine 为 linux 的最小发行版本，貌似只有 5M，debian 是完整版本<br />当然这里还有个坑，docker 的官方镜像一般都是用 debian 作为镜像的，在网上查了下资料，除了包大小区别外，执行机制也有区别，具体没研究过，如<strong>果用在生产环境的话还是优先考虑 debian</strong>吧<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612154129532-cc5c3f56-df9b-447a-a322-6e26a54f1de6.png#height=88&id=WNglP&originHeight=88&originWidth=740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20558&status=done&style=none&title=&width=740" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612154129532-cc5c3f56-df9b-447a-a322-6e26a54f1de6.png#height=88&id=WNglP&originHeight=88&originWidth=740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20558&status=done&style=none&title=&width=740" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612154117039-3ba67c21-7ec8-485f-a622-443efb30470b.png#height=198&id=AEonF&originHeight=198&originWidth=763&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45016&status=done&style=none&title=&width=763" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612154117039-3ba67c21-7ec8-485f-a622-443efb30470b.png#height=198&id=AEonF&originHeight=198&originWidth=763&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45016&status=done&style=none&title=&width=763" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"><br />关于 debian 版本代差的问题这个如果没有历史包袱的话默认 buster 就可以了，node 的 latest 就是用的这个版本，其实可以选择 slim 版本，从官网上给出的代码包大小来看相差了 6 倍，对于内存占用敏感的话可以使用<br /><img src="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612155108323-95c7b955-b383-4ae0-8f53-25972ee74d70.png#height=501&id=bToQ2&originHeight=501&originWidth=1243&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61313&status=done&style=none&title=&width=1243" class="lazyload placeholder" data-srcset="https://img02.sogoucdn.com/v2/thumb/retype_exclude_gif/ext/auto/q/95/crop/xy/ai/t/0/?appid=122&url=cdn.nlark.com/yuque/0/2021/png/268444/1612155108323-95c7b955-b383-4ae0-8f53-25972ee74d70.png#height=501&id=bToQ2&originHeight=501&originWidth=1243&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61313&status=done&style=none&title=&width=1243" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="image.png"></p>
<p>具体怎么自己做 slim <a href="#5kNcS">点击这里</a></p>
<p><a name="ATVC9"></a></p>
<h2 id="dockerfile-缓存机制"><a href="#dockerfile-缓存机制" class="headerlink" title="dockerfile 缓存机制"></a>dockerfile 缓存机制</h2><p>构建映像时，Docker 将逐步<code>Dockerfile</code>执行您的指令，  并按指定的顺序执行每个指令。在检查每条指令时，Docker 会在其缓存中查找可重用的现有映像，而不是创建新的（重复的）映像。<br />如果根本不想使用缓存，则可以使用命令<code>--no-cache=true</code> 上的选项<code>docker build</code>。但是，如果您确实让 Docker 使用其缓存，那么了解何时可以找到匹配的映像，这一点很重要。Docker 遵循的基本规则概述如下：</p>
<ul>
<li>从已在缓存中的父映像开始，将下一条指令与从该基本映像派生的所有子映像进行比较，以查看是否其中一个是使用完全相同的指令构建的。如果不是，则高速缓存无效。</li>
<li>在大多数情况下，只需将中的指令<code>Dockerfile</code>与子图像之一进行比较就足够了。但是，某些说明需要更多的检查和解释。</li>
<li>对于<code>ADD</code>和<code>COPY</code>指令，将检查图像中文件的内容，并为每个文件计算一个校验和。在这些校验和中不考虑文件的最后修改时间和最后访问时间。在缓存查找期间，将校验和与现有映像中的校验和进行比较。如果文件中的任何内容（例如内容和元数据）发生了更改，则缓存将无效。</li>
<li>除了<code>ADD</code>和<code>COPY</code>命令之外，缓存检查不会查看容器中的文件来确定缓存是否匹配。例如，在处理<code>RUN apt-get -y update</code>命令时，不检查容器中更新的文件以确定是否存在缓存命中。在这种情况下，仅使用命令字符串本身来查找匹配项。</li>
</ul>
<p>缓存无效后，所有后续<code>Dockerfile</code>命令都会生成新映像，并且不使用缓存</p>
<p>原文地址：<a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">https://docs.docker.com/develop/develop-images/dockerfile_best-practices&#x2F;</a></p>
<p><a name="jhWzS"></a></p>
<h2 id="关于更多命令"><a href="#关于更多命令" class="headerlink" title="关于更多命令"></a>关于更多命令</h2><p><a name="9wGlq"></a></p>
<h3 id="docker-cli-更多命令"><a href="#docker-cli-更多命令" class="headerlink" title="docker cli 更多命令"></a>docker cli 更多命令</h3><p>官方文档： <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/">https://docs.docker.com/engine/reference/run/</a><br><a name="CTDUU"></a></p>
<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><p><a name="ZAOaR"></a></p>
<h3 id="docker-compose-cli-更多命令"><a href="#docker-compose-cli-更多命令" class="headerlink" title="docker-compose cli 更多命令"></a>docker-compose cli 更多命令</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/reference/overview/">https://docs.docker.com/compose/reference/overview/</a></p>
<p><a name="jvVaM"></a></p>
<h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul>
<li>docekr desktop: <a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-mac/install/">https://docs.docker.com/docker-for-mac/install/</a></li>
<li>docker 新人文档： <a target="_blank" rel="noopener" href="https://docs.docker.com/get-started/">https://docs.docker.com/get-started/</a></li>
</ul>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
      </div>
      <div class="post-tags-categories">
        
        <div class="tags">
          
            <a href="/tags/%E5%89%8D%E7%AB%AF/" class="">
              前端
            </a>
          
            <a href="/tags/docker/" class="">
              docker
            </a>
          
        </div>
        
      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>author:  </strong>梨逍遥</a>
    </li>
    <li class="post-copyright-link">
    <strong>link:  </strong>
    <a href="/2023/06/28/frontend/monitor/docker-ru-men-yi-wen-jiu-gou-liao/" target="_blank" title="docker入门一文就够了">https://ywzzy.github.io/2023/06/28/frontend/monitor/docker-ru-men-yi-wen-jiu-gou-liao/</a>
    </li>
    <li class="post-copyright-license">
      <strong>Copyright notice:   </strong>
      All articles on this website, unless otherwise stated, adopt <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      reprint policy. If reproduced, please indicate source!
    </li>
  </ul>
<div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="https://images.pexels.com/photos/1413100/pexels-photo-1413100.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" class="lazyload placeholder" data-srcset="https://images.pexels.com/photos/1413100/pexels-photo-1413100.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="">
    </div>
    <a href="/2023/06/28/frontend/monitor/sentry-qian-duan-yi-chang-jian-kong/" class="post-nav-link">
      <div class="title">
        <i class="fas fa-angle-left"></i> Prev:
        <div class="title-text">Sentry前端异常监控</div>
      </div>
      
      <!-- <div class="content">
        


前言起初神创造天地，天地处于一片混沌状态，神说，要有光，于是便有了光。———《圣经》

概述Sentry是一款国外
      </div> -->
    </a>
  </div>



  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="https://images.pexels.com/photos/1413100/pexels-photo-1413100.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" class="lazyload placeholder" data-srcset="https://images.pexels.com/photos/1413100/pexels-photo-1413100.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" src="" alt="">
    </div>
    <a href="/2023/06/28/frontend/monitor/sentry-sourcemap/" class="post-nav-link">
      <div class="title">
        Next: <i class="fas fa-angle-right"></i>
        <div class="title-text">sentry - sourceMap</div>
      </div>
      <!-- <div class="content">
        


一、 基于 sentry-cli 上传
第一步：安装 sentry-cli12# 记得全局安装，这样方便点npm 
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- 打赏 -->
    

    <!-- 分享 -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- 文章详情页的分享 -->
<div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>

<script src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>

<!-- comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- 目录 -->
  <aside id='l_side'>
  
    
      <section class="widget side_blogger">
  <div class='content'>
    
      
        <a class='avatar flat-box rectangle' href='/about/'>
          <img src='https://avatars.githubusercontent.com/u/48836340?v=4'/>
        </a>
      
    
    
      <div class='text'>
        
          <h2>梨逍遥</h2>
        
        
          <p>一个码农</p>

        
        
          <p><span id="jinrishici-sentence">梨逍遥</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="/mailto:1738348915@qq.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="https://github.com/YWzzy"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=1738348915"
              class="social fab fa-qq flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
      </div>
    
  </div>
</section>

    
  
  
  
    
  

  <div class="layout_sticky">    
    
      
<section class="widget side_toc">
  
  <header>
    
      <i style="color: " class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name' style="color: ">本文目录</span>
    
  </header>


  <div class='content'>
    <div class="toc-main">
      <div class="toc-content">
        <!-- <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-%E5%AE%89%E8%A3%85"><span class="toc-text">docker 安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A8"><span class="toc-text">启动第一个容器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-text">基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">Docker 架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F%EF%BC%88image%EF%BC%89"><span class="toc-text">镜像（image）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%EF%BC%88container%EF%BC%89"><span class="toc-text">容器（container）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%9C%E5%83%8F-x2F-%E5%AE%B9%E5%99%A8-x2F-%E4%BB%93%E5%BA%93%E4%B8%89%E8%80%85%E5%85%B3%E7%B3%BB"><span class="toc-text">镜像&#x2F;容器&#x2F;仓库三者关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%A5%E6%9C%89%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-text">拥有一个自己的镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-hello-world"><span class="toc-text">创建一个 hello world</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%95%9C%E5%83%8F"><span class="toc-text">执行镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%87%AA%E5%8A%A8%E5%81%9C%E6%AD%A2%EF%BC%9F-why"><span class="toc-text">容器自动停止？ why</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0%EF%BC%9A%E5%B0%81%E8%A3%85%E4%B8%80%E4%B8%AA-node-%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F"><span class="toc-text">练习：封装一个 node 服务镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-koa-%E6%9C%8D%E5%8A%A1"><span class="toc-text">创建 koa 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%95%9C%E5%83%8F"><span class="toc-text">生成镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-text">运行测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%EF%BC%9A%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="toc-text">进阶：持久化存储</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">为什么？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Volume-%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-text">Volume 的类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Named-Volumes"><span class="toc-text">Named Volumes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bind-Mounts"><span class="toc-text">Bind Mounts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="toc-text">怎么用？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#app-%E5%BA%94%E7%94%A8%E7%9A%84%E6%9B%B4%E6%96%B0"><span class="toc-text">app 应用的更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84"><span class="toc-text">文件映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%9B%B4%E6%96%B0"><span class="toc-text">服务更新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pm2-%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0"><span class="toc-text">pm2 自动刷新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%9D%E5%A4%96%E5%85%B3%E6%B3%A8"><span class="toc-text">额外关注</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-%E6%8C%81%E4%B9%85%E5%AD%98%E5%82%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">mysql 持久存储案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84-1"><span class="toc-text">文件映射</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%EF%BC%9A%E5%A4%9A%E5%AE%B9%E5%99%A8%E7%BB%84%E5%90%88%E8%81%94%E5%8A%A8"><span class="toc-text">进阶：多容器组合联动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%A4%9A%E5%AE%B9%E5%99%A8%E8%81%94%E5%8A%A8%EF%BC%9F"><span class="toc-text">为什么要多容器联动？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#network"><span class="toc-text">network</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-compose"><span class="toc-text">docker compose</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-docker-compose%EF%BC%9F"><span class="toc-text">什么是 docker compose？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E8%AF%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">解读配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%AE%B9%E5%99%A8"><span class="toc-text">启动容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4%E6%95%B4%E7%90%86"><span class="toc-text">常用指令整理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E6%A1%88%E4%BE%8B"><span class="toc-text">一些案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E6%8E%A5-mongoDB"><span class="toc-text">链接 mongoDB</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DockerFile-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="toc-text">DockerFile 配置详解</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DockerHub-%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93"><span class="toc-text">DockerHub 远程仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BB%93%E5%BA%93"><span class="toc-text">配置仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91"><span class="toc-text">阿里云</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-Registry"><span class="toc-text">docker Registry</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker-slim-%E9%95%9C%E5%83%8F%E5%8E%8B%E7%BC%A9"><span class="toc-text">docker-slim 镜像压缩</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%95%E7%94%A8%E6%B5%8B%E8%AF%84"><span class="toc-text">试用测评</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-text">使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9D%91"><span class="toc-text">需要注意的坑</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-github-CI-x2F-CD"><span class="toc-text">配置 github CI&#x2F;CD</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9B%B4%E6%8D%A2-docker-%E6%BA%90-%E2%80%93%E5%9B%BD%E5%86%85-cdn"><span class="toc-text">更换 docker 源 –国内 cdn</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81"><span class="toc-text">查看当前状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F%E6%BA%90"><span class="toc-text">阿里云镜像源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-Preferences"><span class="toc-text">设置 Preferences</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%82%E9%A1%B9%E7%9F%A5%E8%AF%86"><span class="toc-text">杂项知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E6%87%82-docker-tag"><span class="toc-text">读懂 docker tag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dockerfile-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6"><span class="toc-text">dockerfile 缓存机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E6%9B%B4%E5%A4%9A%E5%91%BD%E4%BB%A4"><span class="toc-text">关于更多命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-cli-%E6%9B%B4%E5%A4%9A%E5%91%BD%E4%BB%A4"><span class="toc-text">docker cli 更多命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1"><span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-compose-cli-%E6%9B%B4%E5%A4%9A%E5%91%BD%E4%BB%A4"><span class="toc-text">docker-compose cli 更多命令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99"><span class="toc-text">相关资料</span></a></li></ol> -->
        <div class="toc"></div>
      </div>
    </div>
  </div>
</section>
<!-- 手机端目录按钮 -->
<div id="toc-mobile-btn">
  <i class="fas fa-list-ul" aria-hidden="true"></i>
</div>

      
  <section class="widget side_recent_post">
    
  <header>
    
      <a style="color: " href='/tags/'><i class="fas fa-book fa-fw" aria-hidden="true"></i><span class='name'>最新文章</span></a>
    
  </header>


    <div class='content'>
      
      <!-- hash算法 -->
      
      <div class="aside-list">
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/12/19/frontend/react/wei-shi-me-react-hui-chong-xin-xuan-ran/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://images.pexels.com/photos/691668/pexels-photo-691668.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" class="lazyload placeholder" data-srcset="https://images.pexels.com/photos/691668/pexels-photo-691668.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">12-19</span>
                
              </div>
              <a class="post-title" href="/2024/12/19/frontend/react/wei-shi-me-react-hui-chong-xin-xuan-ran/">为什么React会重新渲染</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/08/29/frontend/scrape/puppeteer-zhi-shi-hui-zong/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://images.pexels.com/photos/45863/frog-butterfly-pond-mirroring-45863.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" class="lazyload placeholder" data-srcset="https://images.pexels.com/photos/45863/frog-butterfly-pond-mirroring-45863.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">08-29</span>
                
              </div>
              <a class="post-title" href="/2024/08/29/frontend/scrape/puppeteer-zhi-shi-hui-zong/">puppeteer知识汇总</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/06/27/mind/qian-duan-zhi-shi-ti-xi/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://images.pexels.com/photos/292442/pexels-photo-292442.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" class="lazyload placeholder" data-srcset="https://images.pexels.com/photos/292442/pexels-photo-292442.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">06-27</span>
                
              </div>
              <a class="post-title" href="/2024/06/27/mind/qian-duan-zhi-shi-ti-xi/">前端知识体系</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/06/27/mind/liu-lan-qi/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://images.pexels.com/photos/40896/larch-conifer-cone-branch-tree-40896.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" class="lazyload placeholder" data-srcset="https://images.pexels.com/photos/40896/larch-conifer-cone-branch-tree-40896.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">06-27</span>
                
              </div>
              <a class="post-title" href="/2024/06/27/mind/liu-lan-qi/">浏览器</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/06/08/solution/shi-yong-big.js-jie-jue-js-xiao-shu-jing-du-wen-ti/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://images.pexels.com/photos/326055/pexels-photo-326055.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" class="lazyload placeholder" data-srcset="https://images.pexels.com/photos/326055/pexels-photo-326055.jpeg?auto=compress&cs=tinysrgb&w=600&lazy=load" srcset="https://ossk.cc/file/c40b6c4ba22bbb6b6f944.gif" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">06-08</span>
                
              </div>
              <a class="post-title" href="/2024/06/08/solution/shi-yong-big.js-jie-jue-js-xiao-shu-jing-du-wen-ti/">使用 big.js 解决 js 小数精度问题</a>
            </div>
          </div>
        
      </div>
    </div>
  </section>

    
  </div>
</aside>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //添加方法
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '180000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = '' || '';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// 非http or https开头
						// 本地文件
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




  <script>
  function loadMermaid() {
    if (document.getElementsByClassName('mermaid').length) {
      if (window.mermaidJsLoad) mermaid.init()
      else {
        loadScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(() => {
          window.mermaidJsLoad = true
          mermaid.initialize({
            theme: 'default',
          })
          if ('true') {
            mermaid.init();
          }
        })
      }
    }
  };
  document.addEventListener("DOMContentLoaded", function () {
    loadMermaid();
  })

  document.addEventListener('pjax:complete', function () {
    loadMermaid();
  })
  
</script>


      </main>
    </div>

    <!-- 页脚 -->
    
  
  
    <!-- 底部鱼儿跳动效果，依赖于jquery-->
<div id="j-fish-skip" style=" position: relative;height: 153px;width: auto;"></div>
<script>
  var RENDERER = {
    POINT_INTERVAL: 5,
    FISH_COUNT: 3,
    MAX_INTERVAL_COUNT: 50,
    INIT_HEIGHT_RATE: .5,
    THRESHOLD: 50,
    FISH_COLOR: '',
    init: function () {
      this.setFishColor(); this.setParameters(), this.reconstructMethods(), this.setup(), this.bindEvent(), this.render()
    },
    setFishColor: function () {
      let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
      if (isDark) {
        this.FISH_COLOR = '#222'; // 暗黑色，有时间把这整成一个变量
      } else {
        this.FISH_COLOR = '' || 'rgb(0, 4, 6, 0.8)';
      }
    },
    setParameters: function () {
      this.$window = $(window), this.$container = $("#j-fish-skip"), this.$canvas = $("<canvas />"), this.context = this.$canvas.appendTo(this.$container).get(0).getContext("2d"), this.points = [], this.fishes = [], this.watchIds = []
    },
    createSurfacePoints: function () {
      var t = Math.round(this.width / this.POINT_INTERVAL);
      this.pointInterval = this.width / (t - 1), this.points.push(new SURFACE_POINT(this, 0));
      for (var i = 1; i < t; i++) {
        var e = new SURFACE_POINT(this, i * this.pointInterval),
          h = this.points[i - 1];
        e.setPreviousPoint(h), h.setNextPoint(e), this.points.push(e)
      }
    },
    reconstructMethods: function () {
      this.watchWindowSize = this.watchWindowSize.bind(this), this.jdugeToStopResize = this.jdugeToStopResize.bind(this), this.startEpicenter = this.startEpicenter.bind(this), this.moveEpicenter = this.moveEpicenter.bind(this), this.reverseVertical = this.reverseVertical.bind(this), this.render = this.render.bind(this)
    },
    setup: function () {
      this.points.length = 0, this.fishes.length = 0, this.watchIds.length = 0, this.intervalCount = this.MAX_INTERVAL_COUNT, this.width = this.$container.width(), this.height = this.$container.height(), this.fishCount = this.FISH_COUNT * this.width / 500 * this.height / 500, this.$canvas.attr({
        width: this.width,
        height: this.height
      }), this.reverse = !1, this.fishes.push(new FISH(this)), this.createSurfacePoints()
    },
    watchWindowSize: function () {
      this.clearTimer(), this.tmpWidth = this.$window.width(), this.tmpHeight = this.$window.height(), this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL))
    },
    clearTimer: function () {
      for (; this.watchIds.length > 0;) clearTimeout(this.watchIds.pop())
    },
    jdugeToStopResize: function () {
      var t = this.$window.width(),
        i = this.$window.height(),
        e = t == this.tmpWidth && i == this.tmpHeight;
      this.tmpWidth = t, this.tmpHeight = i, e && this.setup()
    },
    bindEvent: function () {
      this.$window.on("resize", this.watchWindowSize), this.$container.on("mouseenter", this.startEpicenter), this.$container.on("mousemove", this.moveEpicenter)
    },
    getAxis: function (t) {
      var i = this.$container.offset();
      return {
        x: t.clientX - i.left + this.$window.scrollLeft(),
        y: t.clientY - i.top + this.$window.scrollTop()
      }
    },
    startEpicenter: function (t) {
      this.axis = this.getAxis(t)
    },
    moveEpicenter: function (t) {
      var i = this.getAxis(t);
      this.axis || (this.axis = i), this.generateEpicenter(i.x, i.y, i.y - this.axis.y), this.axis = i
    },
    generateEpicenter: function (t, i, e) {
      if (!(i < this.height / 2 - this.THRESHOLD || i > this.height / 2 + this.THRESHOLD)) {
        var h = Math.round(t / this.pointInterval);
        h < 0 || h >= this.points.length || this.points[h].interfere(i, e)
      }
    },
    reverseVertical: function () {
      this.reverse = !this.reverse;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].reverseVertical()
    },
    controlStatus: function () {
      for (var t = 0, i = this.points.length; t < i; t++) this.points[t].updateSelf();
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].updateNeighbors();
      this.fishes.length < this.fishCount && 0 == --this.intervalCount && (this.intervalCount = this.MAX_INTERVAL_COUNT, this.fishes.push(new FISH(this)))
    },
    render: function () {
      requestAnimationFrame(this.render), this.controlStatus(), this.context.clearRect(0, 0, this.width, this.height), this.context.fillStyle = this.FISH_COLOR;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].render(this.context);
      this.context.save(), this.context.globalCompositeOperation = "xor", this.context.beginPath(), this.context.moveTo(0, this.reverse ? 0 : this.height);
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].render(this.context);
      this.context.lineTo(this.width, this.reverse ? 0 : this.height), this.context.closePath(), this.context.fill(), this.context.restore()
    }
  },
  SURFACE_POINT = function (t, i) {
    this.renderer = t, this.x = i, this.init()
  };
  SURFACE_POINT.prototype = {
    SPRING_CONSTANT: .03,
    SPRING_FRICTION: .9,
    WAVE_SPREAD: .3,
    ACCELARATION_RATE: .01,
    init: function () {
      this.initHeight = this.renderer.height * this.renderer.INIT_HEIGHT_RATE, this.height = this.initHeight, this.fy = 0, this.force = {
        previous: 0,
        next: 0
      }
    },
    setPreviousPoint: function (t) {
      this.previous = t
    },
    setNextPoint: function (t) {
      this.next = t
    },
    interfere: function (t, i) {
      this.fy = this.renderer.height * this.ACCELARATION_RATE * (this.renderer.height - this.height - t >= 0 ? -1 : 1) * Math.abs(i)
    },
    updateSelf: function () {
      this.fy += this.SPRING_CONSTANT * (this.initHeight - this.height), this.fy *= this.SPRING_FRICTION, this.height += this.fy
    },
    updateNeighbors: function () {
      this.previous && (this.force.previous = this.WAVE_SPREAD * (this.height - this.previous.height)), this.next && (this.force.next = this.WAVE_SPREAD * (this.height - this.next.height))
    },
    render: function (t) {
      this.previous && (this.previous.height += this.force.previous, this.previous.fy += this.force.previous), this.next && (this.next.height += this.force.next, this.next.fy += this.force.next), t.lineTo(this.x, this.renderer.height - this.height)
    }
  };
  var FISH = function (t) {
    this.renderer = t, this.init()
  };
  FISH.prototype = {
    GRAVITY: .4,
    init: function () {
      this.direction = Math.random() < .5, this.x = this.direction ? this.renderer.width + this.renderer.THRESHOLD : -this.renderer.THRESHOLD, this.previousY = this.y, this.vx = this.getRandomValue(4, 10) * (this.direction ? -1 : 1), this.renderer.reverse ? (this.y = this.getRandomValue(1 * this.renderer.height / 10, 4 * this.renderer.height / 10), this.vy = this.getRandomValue(2, 5), this.ay = this.getRandomValue(.05, .2)) : (this.y = this.getRandomValue(6 * this.renderer.height / 10, 9 * this.renderer.height / 10), this.vy = this.getRandomValue(-5, -2), this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1, this.theta = 0, this.phi = 0
    },
    getRandomValue: function (t, i) {
      return t + (i - t) * Math.random()
    },
    reverseVertical: function () {
      this.isOut = !this.isOut, this.ay *= -1
    },
    controlStatus: function (t) {
      this.previousY = this.y, this.x += this.vx, this.y += this.vy, this.vy += this.ay, this.renderer.reverse ? this.y > this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy -= this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(.05, .2)), this.isOut = !1) : this.y < this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy += this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1), this.isOut || (this.theta += Math.PI / 20, this.theta %= 2 * Math.PI, this.phi += Math.PI / 30, this.phi %= 2 * Math.PI), this.renderer.generateEpicenter(this.x + (this.direction ? -1 : 1) * this.renderer.THRESHOLD, this.y, this.y - this.previousY), (this.vx > 0 && this.x > this.renderer.width + this.renderer.THRESHOLD || this.vx < 0 && this.x < -this.renderer.THRESHOLD) && this.init()
    },
    render: function (t) {
      t.save(), t.translate(this.x, this.y), t.rotate(Math.PI + Math.atan2(this.vy, this.vx)), t.scale(1, this.direction ? 1 : -1), t.beginPath(), t.moveTo(-30, 0), t.bezierCurveTo(-20, 15, 15, 10, 40, 0), t.bezierCurveTo(15, -10, -20, -15, -30, 0), t.fill(), t.save(), t.translate(40, 0), t.scale(.9 + .2 * Math.sin(this.theta), 1), t.beginPath(), t.moveTo(0, 0), t.quadraticCurveTo(5, 10, 20, 8), t.quadraticCurveTo(12, 5, 10, 0), t.quadraticCurveTo(12, -5, 20, -8), t.quadraticCurveTo(5, -10, 0, 0), t.fill(), t.restore(), t.save(), t.translate(-3, 0), t.rotate((Math.PI / 3 + Math.PI / 10 * Math.sin(this.phi)) * (this.renderer.reverse ? -1 : 1)), t.beginPath(), this.renderer.reverse ? (t.moveTo(5, 0), t.bezierCurveTo(10, 10, 10, 30, 0, 40), t.bezierCurveTo(-12, 25, -8, 10, 0, 0)) : (t.moveTo(-5, 0), t.bezierCurveTo(-10, -10, -10, -30, 0, -40), t.bezierCurveTo(12, -25, 8, -10, 0, 0)), t.closePath(), t.fill(), t.restore(), t.restore(), this.controlStatus(t)
    }
  }, $(function () {
    RENDERER.init()
    $('.dark').click(function () {
      setTimeout(() => {
        RENDERER.setFishColor();
        RENDERER.context.fill();
      });
    })
  });
</script>
  
  <div class="footer bg-color">
    <div class="footer-main">
      
        
          <div class="link">
            
              
                <a href="mailto:1738348915@qq.com" class="social">
                  
                    <i class="fas fa-envelope" aria-hidden="true"></i>
                  
                </a>
              
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright © 2019 - 2024 <a target="_blank" rel="noopener" href="https://gitee.com/yhyinhan">zhangzhiyong</a> | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a></p>

          </div>
        
      
        
          <div class="footer-custom">
            
              <div><br></div>
            
              <div><br></div>
            
          </div>
        
      
    </div>
  </div>



    <!-- 渲染暗黑按钮 -->
    
      <div class="dark">
  <div class="dark-content">
    <i class="fas fa-moon" aria-hidden="true"></i>
    <!-- <span>关灯</span> -->
  </div>
  
</div>

<script>
  $(function() {
    let isDark = JSON.parse(localStorage.getItem('dark'))  || JSON.parse('false');
    if (isDark) {
      $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
    }
    $('.dark').click(function() {
      if ($(document.body).is('.darkModel')) {
        $(document.body).removeClass('darkModel');
        localStorage.setItem('dark', false);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-moon" aria-hidden="true"></i>
          </div>
          `
        );
      } else {
        $(document.body).addClass('darkModel');
        localStorage.setItem('dark', true);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
      }
    })
  })
</script>
    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script src="/js/goTop.js"></script>

    
    <!-- 渲染左下角音乐播放器 -->
    

    <!-- 图片放大 -->
    

    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <!-- 背景彩带 -->
    
      <script type="text/javascript" size="100" alpha='0.4' zIndex="-1" src="/js/ribbon.min.js"></script>
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- 文章目录所需js -->
<!-- <link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script> -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.css">

<script>
  var headerEl = 'h1, h2, h3, h4, h5',  //headers 
    content = '.post-detail',//文章容器
    idArr = {};  //标题数组以确定是否增加索引id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -70,
    // headingsOffset: -($(window).height() * 0.4 - 45),
    headingsOffset: -($(window).height() * 0.4 - 70),
    // positionFixedSelector: '.toc-main',
    // positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    orderedList: true,
    collapseDepth: 3,
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 150) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // 手机端toc按钮点击出现目录
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('side_toc')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // 小于992px的时候
        mobileToc.close()
      }
    })
  }
</script>

<style>
  /* .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  } */
</style>
 

<!-- 设置导航背景 -->
<script>
  let setHeaderClass = () => {
    const nav = $('#navHeader');
    const navTop = nav.outerHeight();
    const winTop = $(window).scrollTop();
    if(winTop > navTop) {
      nav.addClass('header-bg-color');
    }
    else {
      nav.removeClass('header-bg-color');
    }
  };

  let scrollCollect = () => {
    return bamboo.throttle(function (e) {
      setHeaderClass();
    }, 200)()
  }

  let initHeaderBg = () => {
    setHeaderClass();
  }

  setHeaderClass();
  window.addEventListener('scroll', scrollCollect);

  document.addEventListener('pjax:send', function () {
    window.removeEventListener('scroll', scrollCollect)
  })
  document.addEventListener('pjax:complete', function () {
    window.addEventListener('scroll', scrollCollect);
    setHeaderClass();
  })
</script> 

<!-- 渲染issues标签里的内容 -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- 渲染远程json加载的图片标签(getPhotoOnline)里的内容 -->
<script>
  function loadPhotoOnlineJS() {
    if ($(".post-detail").find(".getJsonPhoto-api").length == 0) {
      return;
    } 
    loadScript('/js/getPhotoOnline/index.js');
  };
  $(function () {
    loadPhotoOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getPhotoJson == "undefined") {
      loadPhotoOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的talk标签(getTalkOnline)里的内容 -->
<script>
  function loadTalkOnlineJS() {
    if ($(".post-detail").find(".getJsonTalk-api").length == 0) {
      return;
    } 
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/waterfall.js/1.0.2/waterfall.min.js'); // 瀑布流插件，https://raphamorim.io/waterfall.js/
    loadScript('/js/getTalkOnline/index.js');
  };
  $(function () {
    loadTalkOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getTalkJson == "undefined") {
      loadTalkOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的site-card标签(getSiteOnline)里的内容 -->
<script>
  function loadSiteOnlineJS() {
    if ($(".post-detail").find(".getJsonSite-api").length == 0) {
      return;
    } 
    loadScript('/js/getSiteOnline/index.js');
  };
  $(function () {
    loadSiteOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getSiteJson == "undefined") {
      loadSiteOnlineJS();
    }
  })
</script>

<!-- 输入框打字特效 -->
<!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


<!-- markdown代码一键复制功能 -->

  <link rel="stylesheet" href="https://unpkg.com/v-plugs-ayu/lib/ayu.css">
  <script src="https://unpkg.com/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = 'copy';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "成功",
            content: "代码已复制",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- 图片懒加载 -->
<script defer src="https://unpkg.com/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- 卡片滚动动画 -->
   

<!-- 评论所需js -->

  
    <script type="text/javascript">
  var utteranceCommon = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    if (isDark) {
      utteranceCommon.Theme = 'github-dark';
    } else {
      utteranceCommon.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // 匿名函数，防止污染全局变量
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceCommon.Theme)
      utterances.setAttribute('repo', 'YWzzy/utterance_repo')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content 是要插入评论的地方
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceCommon.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
  


<!-- 鼠标点击特效 -->
<!-- 爱心点击 -->

  
    <script src="/js/cursor/fireworks.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" data-pjax></script>


<!-- 轮播图标签 -->
<script>
  var bambooSwiperTag = {};
  function load_swiper() {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    loadCSS("https://unpkg.com/swiper@6/swiper-bundle.min.css")
    loadScript("https://unpkg.com/swiper@6/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    bambooSwiperTag.swiper = new Swiper('.post-swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      autoplay: true ? {
        delay: 3000,
        stopOnLastSlide: false,
        disableOnInteraction: false,
      } : false,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      on:{
        init: function(){
          swiperAnimateCache(this); //隐藏动画元素 
          swiperAnimate(this); //初始化完成开始动画
        }, 
        slideChangeTransitionEnd: function(){ 
          swiperAnimate(this); //每个slide切换结束时也运行当前slide动画
          //this.slides.eq(this.activeIndex).find('.ani').removeClass('ani'); 动画只展现一次，去除ani类名
        } 
      }
    });
  }

  document.addEventListener('pjax:complete', function () {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    if (typeof bambooSwiperTag.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>
    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <div class="loading-circle"><div id="loader-circle"></div></div>
    <script>
      window.ShowLoading = function() {
        $(".loading-circle").css("display", "block");
      };
      window.HideLoading = function() {
        $(".loading-circle").css("display", "none");
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // 拦截正常带链接的 a 标签
      selectors: ["#pjax-container","title"],                                   // 根据实际需要确认重载区域
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // 刷新不从顶部开始
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>